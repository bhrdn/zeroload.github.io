<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="fHash.py (https://pastebin.com/tEw7BPtX)   Given a custom hash, the task is to create some kind of collision in order to get the flag. At this moment, I don’t know what’s this second-preimage thing,">
<meta property="og:type" content="article">
<meta property="og:title" content="SharifCTF 2018 - fHash Writeup">
<meta property="og:url" content="https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/index.html">
<meta property="og:site_name" content="Catousify">
<meta property="og:description" content="fHash.py (https://pastebin.com/tEw7BPtX)   Given a custom hash, the task is to create some kind of collision in order to get the flag. At this moment, I don’t know what’s this second-preimage thing,">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://a.safe.moe/MceKg">
<meta property="og:image" content="https://a.safe.moe/gVUMe.png">
<meta property="og:image" content="https://a.safe.moe/N08T6.png">
<meta property="og:image" content="https://a.safe.moe/qBlm0.png">
<meta property="og:updated_time" content="2018-10-16T17:54:22.649Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SharifCTF 2018 - fHash Writeup">
<meta name="twitter:description" content="fHash.py (https://pastebin.com/tEw7BPtX)   Given a custom hash, the task is to create some kind of collision in order to get the flag. At this moment, I don’t know what’s this second-preimage thing,">
<meta name="twitter:image" content="https://a.safe.moe/MceKg">
    
    
        
          
              <link rel="shortcut icon" href="/img/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>SharifCTF 2018 - fHash Writeup</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Catousify" type="application/atom+xml" />
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/05/07/simple-vm-joints-2018-writeup/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2017/12/17/inctf-2017-secure-auth-writeup/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&text=SharifCTF 2018 - fHash Writeup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&is_video=false&description=SharifCTF 2018 - fHash Writeup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SharifCTF 2018 - fHash Writeup&body=Check out this article: https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&name=SharifCTF 2018 - fHash Writeup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        SharifCTF 2018 - fHash Writeup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Catousify</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-02-04T09:16:15.000Z" itemprop="datePublished">2018-02-04</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>fHash.py (<a href="https://pastebin.com/tEw7BPtX" target="_blank" rel="noopener">https://pastebin.com/tEw7BPtX</a>)</p>
</blockquote>
<p><img src="https://a.safe.moe/MceKg" alt=""> Given a custom hash, the task is to create some kind of collision in order to get the flag. At this moment, I don’t know what’s this second-preimage thing, but the task is clear enough somehow we should get the collision with restriction <code>hl1 != hl2</code> and <code>hr1 != hr2</code> and <code>M1 != M2</code>. <code>hl</code> and <code>hr</code> <strong>must</strong> be 2 bytes and <code>M</code> <strong>must</strong> be 4 bytes. First, analyze the algorithm used.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(h, m)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> md5(h.encode(<span class="string">'utf-8'</span>) + m.encode(<span class="string">'utf-8'</span>)).hexdigest()[:<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">round</span><span class="params">(hl, m, hr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> foo(hl, m), foo(hr, m)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fHash</span><span class="params">(hl, hr, M)</span>:</span></span><br><span class="line">    message = list(map(<span class="string">''</span>.join, zip(*[iter(M)] * <span class="number">4</span>)))</span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> message:</span><br><span class="line">        hl, hr = round(hl, m, hr)</span><br><span class="line">    <span class="keyword">return</span> (hl, hr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(fHash(<span class="string">'7575'</span>, <span class="string">'A8A8'</span>, <span class="string">'7368617269666374'</span>))</span><br></pre></td></tr></table></figure>
<p><code>M</code> length must be the power of 4 so that it can be sliced into parts by 2 bytes. As for example <code>7368617269666374</code> =&gt; <code>7368</code>,<code>6172</code>,<code>6966</code>, and <code>6374</code>. After that, sliced <code>M</code> get to concatenated with <code>hl</code> or <code>hr</code> then the first 2 bytes of md5sum from the concatenated string will be used for next round <code>hl</code> or <code>hr</code>, repeated until last sliced part of <code>M</code>. For example, <code>7575</code> and <code>7368</code> =&gt; <code>md5sum(75757368)[:4]</code> =&gt; <code>dcd0</code> =&gt; <code>dcd0</code> and <code>6172</code> =&gt; <code>md5sum(dcd06172)[:4]</code> =&gt; and so on.. In diagram <img src="https://a.safe.moe/gVUMe.png" alt=""> Attack. Yes, Attacc boi. The flaw is in <code>foo(h, m)</code> where the return only the first 2 bytes of <code>md5sum(h + m)</code>. At first, my approach was to get all the bytes from <code>hl</code>, <code>hr</code>, and <code>M</code> to be different. That’s where the exhausting part, until I just realized, <strong>all of the bytes doesn’t needs to be different</strong> :|. Side story aside, the idea for this is to change the bytes used first round and the return for foo must be same as use in <code>hl1</code>, <code>hr1</code>, and <code>M1</code>. I did this with a crude bruteforce way,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(h, m)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> md5(h.encode(<span class="string">'utf-8'</span>) + m.encode(<span class="string">'utf-8'</span>)).hexdigest()[:<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">alpha = <span class="string">'0123456789ABCDEF'</span></span><br><span class="line"><span class="comment"># alpha = '0123456789abcdef'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> hex1 <span class="keyword">in</span> alpha:</span><br><span class="line">    <span class="keyword">for</span> hex2 <span class="keyword">in</span> alpha:</span><br><span class="line">        <span class="keyword">for</span> hex3 <span class="keyword">in</span> alpha:</span><br><span class="line">            <span class="keyword">for</span> hex4 <span class="keyword">in</span> alpha:</span><br><span class="line">                <span class="keyword">for</span> hex5 <span class="keyword">in</span> alpha:</span><br><span class="line">                    <span class="keyword">for</span> hex6 <span class="keyword">in</span> alpha:</span><br><span class="line">                        <span class="keyword">for</span> hex7 <span class="keyword">in</span> alpha:</span><br><span class="line">                            <span class="keyword">for</span> hex8 <span class="keyword">in</span> alpha:</span><br><span class="line">                                m =  hex1 + hex2 + hex3 + hex4</span><br><span class="line">                                hl = hex5 + hex6 + hex7 + hex8</span><br><span class="line">                                <span class="keyword">if</span> foo(hl, m) == <span class="string">'dcd0'</span>:</span><br><span class="line">                                    <span class="keyword">for</span> hex9 <span class="keyword">in</span> alpha:</span><br><span class="line">                                        <span class="keyword">for</span> hex10 <span class="keyword">in</span> alpha:</span><br><span class="line">                                            <span class="keyword">for</span> hex11 <span class="keyword">in</span> alpha:</span><br><span class="line">                                                <span class="keyword">for</span> hex12 <span class="keyword">in</span> alpha:</span><br><span class="line">                                                    hr = hex9 + hex10 + hex11 + hex12</span><br><span class="line">                                                    <span class="keyword">if</span> foo(hr, m) == <span class="string">'a6ea'</span>:</span><br><span class="line">                                                        <span class="keyword">print</span> hl, m, hr</span><br><span class="line">                                                        sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>I put break at the end just to output one result, in fact there are dozens of result if this didn’t stopped. It doesn’t need to take long to run this bruteforce script, the output,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">45ED 0007 E19F</span><br></pre></td></tr></table></figure>
<p>In diagram, <img src="https://a.safe.moe/N08T6.png" alt=""><br>The final answer, <code>hl2 = 45ED</code>, <code>hr2 = E19F</code>, <code>M2 = 0007617269666374</code>.<br><img src="https://a.safe.moe/qBlm0.png" alt=""></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&text=SharifCTF 2018 - fHash Writeup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&is_video=false&description=SharifCTF 2018 - fHash Writeup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SharifCTF 2018 - fHash Writeup&body=Check out this article: https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&title=SharifCTF 2018 - fHash Writeup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://zeroload.github.io/2018/02/04/sharifctf-2018-fhash-writeup/&name=SharifCTF 2018 - fHash Writeup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 zeroload
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'zeroload-github-io';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


