<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="This your last chance. After this there is no turning back. You take the blue pill, the story ends. You wake up in your bed and believe whatever you want to. You take the red pill, you stay in Wonder">
<meta property="og:type" content="article">
<meta property="og:title" content="Security Fest CTF 2018 - bluepill">
<meta property="og:url" content="https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/index.html">
<meta property="og:site_name" content="Catousify">
<meta property="og:description" content="This your last chance. After this there is no turning back. You take the blue pill, the story ends. You wake up in your bed and believe whatever you want to. You take the red pill, you stay in Wonder">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-10-16T17:54:22.645Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Security Fest CTF 2018 - bluepill">
<meta name="twitter:description" content="This your last chance. After this there is no turning back. You take the blue pill, the story ends. You wake up in your bed and believe whatever you want to. You take the red pill, you stay in Wonder">
    
    
        
          
              <link rel="shortcut icon" href="/img/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Security Fest CTF 2018 - bluepill</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Catousify" type="application/atom+xml" />
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/07/23/CTFZone-2018-Quals-android-ololo-country-checker/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/06/02/Security-Fest-CTF-2018-sshnuke/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&text=Security Fest CTF 2018 - bluepill"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&is_video=false&description=Security Fest CTF 2018 - bluepill"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Security Fest CTF 2018 - bluepill&body=Check out this article: https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&name=Security Fest CTF 2018 - bluepill&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Security Fest CTF 2018 - bluepill
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Catousify</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-06-02T09:12:00.000Z" itemprop="datePublished">2018-06-02</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>This your last chance. After this there is no turning back. You take the blue pill, the story ends. You wake up in your bed and believe whatever you want to. You take the red pill, you stay in Wonderland, and I show you how deep the rabbit hole goes. Remember, all I’m offering is the truth. Nothing more. This challenge was sponsored by ATEA! If you are a local student player you are eligible to turn in the flag at the ATEA booth for a prize!</p>
<p>Solves: 27</p>
<p>Service: nc rev.trinity.neo.ctf.rocks 31337 or nc 209.97.136.62 31337</p>
<p>Download: bluepill.tar.gz</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvf bluepill.tar.gz</span><br><span class="line">bluepill.ko</span><br><span class="line">init</span><br><span class="line">run.sh</span><br><span class="line">tiny.kernel</span><br><span class="line">$ file bluepill.ko</span><br><span class="line">bluepill.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=3e46a2d1b5659bcf7947bb4ec5c11d2226289df1, not stripped</span><br><span class="line">$ cat run.sh</span><br><span class="line"><span class="meta">#! /usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -kernel ./tiny.kernel -initrd ./init -m 32 -nographic -append <span class="string">"console=ttyS0"</span></span><br></pre></td></tr></table></figure>
<p>An unique one i guess, it’s rare to see a kernel problem on reversing category but the goal is clear, we have to reverse engineer the kernel module.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">bluepill_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 v0; <span class="comment">// rcx</span></span><br><span class="line">  file_operations *v1; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  printk(<span class="string">"\x016[BLUEPILL] Loaded ...\n"</span>);</span><br><span class="line">  v0 = <span class="number">62L</span>L;</span><br><span class="line">  v1 = &amp;fops_35702;</span><br><span class="line">  <span class="keyword">while</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v1-&gt;owner) = <span class="number">0</span>;</span><br><span class="line">    v1 = (file_operations *)((<span class="keyword">char</span> *)v1 + <span class="number">4</span>);</span><br><span class="line">    --v0;</span><br><span class="line">  &#125;</span><br><span class="line">  fops_35702.write = (<span class="keyword">ssize_t</span> (*)(file *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *))pill_choice;</span><br><span class="line">  proc_create(<span class="string">"bluepill"</span>, <span class="number">0666L</span>L, <span class="number">0L</span>L, &amp;fops_35702);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So, kernel module create a rw (0666) proc at <code>/proc/bluepill</code>, with <code>write</code> routine at <code>pill_choice</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> __<span class="function">fastcall <span class="title">pill_choice</span><span class="params">(file *sp_file, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// r12</span></span><br><span class="line">  file *v5; <span class="comment">// rax</span></span><br><span class="line">  file *v6; <span class="comment">// rbx</span></span><br><span class="line">  file *v7; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> __int8 *v8; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// r13</span></span><br><span class="line">  __int64 v10; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v13; <span class="comment">// rdi</span></span><br><span class="line">  _QWORD *v14; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v15; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *i; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 digest[<span class="number">8</span>]; <span class="comment">// [rsp+7h] [rbp-59h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+Fh] [rbp-51h]</span></span><br><span class="line">  __int64 s2; <span class="comment">// [rsp+17h] [rbp-49h]</span></span><br><span class="line">  <span class="keyword">char</span> v21; <span class="comment">// [rsp+1Fh] [rbp-41h]</span></span><br><span class="line"></span><br><span class="line">  v4 = strncpy_from_user(&amp;user_input, buf, <span class="number">20L</span>L, offset);</span><br><span class="line">  v5 = file_open(<span class="string">"/proc/version"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v5;</span><br><span class="line">    file_read(v5, (<span class="keyword">unsigned</span> __int8 *)magic, <span class="number">0x1F4</span>u);</span><br><span class="line">    v7 = v6;</span><br><span class="line">    v8 = &amp;user_input;</span><br><span class="line">    filp_close(v7, <span class="number">0L</span>L);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;user_input) &gt; <span class="number">0xB</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = const_bss;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v10 = <span class="number">0L</span>L;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v21, <span class="number">0</span>, <span class="number">0x19</span>uLL);</span><br><span class="line">        *(_QWORD *)digest = <span class="number">0L</span>L;</span><br><span class="line">        v19 = <span class="number">0L</span>L;</span><br><span class="line">        s2 = <span class="number">0L</span>L;</span><br><span class="line">        calc(v8, <span class="number">4u</span>LL, digest);</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v11 = magic[v10];</span><br><span class="line">          v12 = digest[v10];</span><br><span class="line">          v13 = <span class="number">2</span> * v10++;</span><br><span class="line">          <span class="built_in">sprintf</span>((<span class="keyword">char</span> *)&amp;s2 + v13, <span class="string">"%02x"</span>, v11 ^ v12);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v10 != <span class="number">16</span> );</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(v9, &amp;s2, <span class="number">0x20</span>uLL) )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v8 += <span class="number">4</span>;</span><br><span class="line">        v9 += <span class="number">0x21</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v8 == &amp;user_input + <span class="number">12</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          printk(<span class="string">"\x011[BLUEPILL] You made the right choice! Now see the world for what it really is ..................... !\n"</span>);</span><br><span class="line">          v14 = &amp;init_task;</span><br><span class="line">          <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v15 = v14[<span class="number">58</span>];</span><br><span class="line">            v14 = (_QWORD *)(v15 - <span class="number">0x1D0</span>);</span><br><span class="line">            <span class="keyword">if</span> ( (_UNKNOWN *)(v15 - <span class="number">0x1D0</span>) == &amp;init_task )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v15 + <span class="number">192</span> != *(_QWORD *)(v15 + <span class="number">192</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">for</span> ( i = *(_QWORD **)(v15 + <span class="number">192</span>); (_QWORD *)(v15 + <span class="number">192</span>) != i; i = (_QWORD *)*i )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( *(_DWORD *)(i[<span class="number">36</span>] + <span class="number">4L</span>L) == <span class="number">1337</span> )</span><br><span class="line">                  i[<span class="number">36</span>] = *(_QWORD *)(v15 + <span class="number">496</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> v4;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  printk(<span class="string">"\x011[BLUEPILL] Morpheus sighs loudly .................................................................. \n"</span>);</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here, the first check to <code>user_input</code> is <code>if ( strlen(&amp;user_input) &gt; 0xB )</code>. So, take a note for that. Then, somehow it gets calculated <code>calc(v8, 4uLL, digest);</code>. What’s this calc function does?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">calc_md5</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> __int8 *initial_msg, <span class="keyword">size_t</span> initial_len, <span class="keyword">unsigned</span> __int8 *digest)</span></span></span><br><span class="line">...</span><br><span class="line">  qmemcpy(msg, v3, initial_len);</span><br><span class="line">  msg[initial_len] = <span class="number">-128</span>;</span><br><span class="line">  <span class="keyword">while</span> ( i &gt; v6 )</span><br><span class="line">    msg[v6++] = <span class="number">0</span>;</span><br><span class="line">  v8 = <span class="number">0x98BADCFE</span>;</span><br><span class="line">  v9 = <span class="number">0xEFCDAB89</span>;</span><br><span class="line">  v10 = <span class="number">0x67452301</span>;</span><br><span class="line">  to_bytes(<span class="number">8</span> * initial_len, &amp;msg[i]);</span><br><span class="line">  to_bytes(v13 &gt;&gt; <span class="number">29</span>, (v12 + v11 + <span class="number">4</span>));</span><br><span class="line">  v15 = v14;</span><br><span class="line">...</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v29 = v23 ^ v25 &amp; (v23 ^ v24);</span><br><span class="line">      &#125;</span><br><span class="line">      v31 = v26 + w[v28] + k[v27] + v29;</span><br><span class="line">      v32 = r[v27++];</span><br><span class="line">      v33 = __ROL4__(v31, v32);</span><br><span class="line">      v26 = v23;</span><br><span class="line">      v34 = v25 + v33;</span><br><span class="line">      <span class="keyword">if</span> ( v27 == <span class="number">64</span> )</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>The calc function is huge, some byte magic happen in place, so I’m guessing this is a hash function. A <strong>md5</strong> hash to be exact, because there are these constant <code>0x98BADCFE</code>, <code>0xEFCDAB89</code>, and <code>0x67452301</code>.</p>
<p>Back to <code>pill_choice</code> function again, so we know that our <code>user_input</code> got calculated with md5. Next check happen at this part,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">v5 = file_open(<span class="string">"/proc/version"</span>);</span><br><span class="line">...</span><br><span class="line">v9 = const_data;</span><br><span class="line">...</span><br><span class="line">file_read(v5, (<span class="keyword">unsigned</span> __int8 *)magic, <span class="number">0x1F4</span>u);</span><br><span class="line">...</span><br><span class="line">v10 = <span class="number">0L</span>L;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  v11 = magic[v10];</span><br><span class="line">  v12 = digest[v10];</span><br><span class="line">  v13 = <span class="number">2</span> * v10++;</span><br><span class="line">  <span class="built_in">sprintf</span>((<span class="keyword">char</span> *)&amp;s2 + v13, <span class="string">"%02x"</span>, v11 ^ v12);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v10 != <span class="number">16</span> );</span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">memcmp</span>(v9, &amp;s2, <span class="number">0x20</span>uLL) )</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">v8 += <span class="number">4</span>;</span><br><span class="line">v9 += <span class="number">0x21</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Now, our <strong>hashed</strong> <code>user_input</code> got <em>xor</em>-ed with bytes from <code>/proc/version</code>, then compare it with constant at <code>.data</code> section.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000000800 const_md5       db &apos;40369e8c78b46122a4e813228ae8ee6e&apos;,0</span><br><span class="line">.data:0000000000000821                 db &apos;e4a75afe114e4483a46aaa20fe4e6ead&apos;,0</span><br><span class="line">.data:0000000000000842                 db &apos;8c3749214f4a9131ebc67e6c7a86d162&apos;,0</span><br></pre></td></tr></table></figure>
<p>Welp, thats all the checks. Lets sum it up</p>
<ul>
<li><code>strlen(user_input) &gt; 11</code></li>
<li><code>md5(user_input[0:4]) ^ bytes(/proc/version) == &#39;40369e8c78b46122a4e813228ae8ee6e&#39;</code></li>
<li><code>md5(user_input[4:8]) ^ bytes(/proc/version) == &#39;e4a75afe114e4483a46aaa20fe4e6ead&#39;</code></li>
<li><code>md5(user_input[8:12]) ^ bytes(/proc/version) == &#39;8c3749214f4a9131ebc67e6c7a86d162&#39;</code></li>
</ul>
<p>Oh, right, the content from <code>/proc/version</code> is <code>Linux version 4.17.0-rc4+ (likvidera@ubuntu) (gcc version 7.2.0 (Ubuntu 7.2.0-8ubuntu3.2)) #9 Sat May 12 12:57:01 PDT 2018</code></p>
<hr>
<p>Final solver script, this script just xor the constant from <code>.data</code> section with bytes from <code>/proc/version</code> which print the real md5 of our <code>user_input</code> then pass the real md5 to site like, hashkiller, etc.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">procver = <span class="string">'Linux version 4.17.0-rc4+ (likvidera@ubuntu) (gcc version 7.2.0 (Ubuntu 7.2.0-8ubuntu3.2)) #9 Sat May 12 12:57:01 PDT 2018'</span></span><br><span class="line"></span><br><span class="line">const = [</span><br><span class="line">    <span class="string">'40369e8c78b46122a4e813228ae8ee6e'</span>,</span><br><span class="line">    <span class="string">'e4a75afe114e4483a46aaa20fe4e6ead'</span>,</span><br><span class="line">    <span class="string">'8c3749214f4a9131ebc67e6c7a86d162'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">new_const = []</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> const:</span><br><span class="line">    new_const.append(map(<span class="keyword">lambda</span> x: int(x, <span class="number">16</span>), [c[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(c), <span class="number">2</span>)]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> new_const:</span><br><span class="line">    raw = <span class="string">''</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> c:</span><br><span class="line">        raw += hex(ord(procver[i]) ^ k)[<span class="number">2</span>:].rjust(<span class="number">2</span>, <span class="string">'0'</span>)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">print</span> raw</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python solve.py</span><br><span class="line">0c5ff0f900941747d69b7a4de4c8da40</span><br><span class="line">a8ce348b696e32e6d619c34f906e5a83</span><br><span class="line">c05e2754376ae75499b5170314a6e54c</span><br></pre></td></tr></table></figure>
<p>… From <a href="https://hashkiller.co.uk" target="_blank" rel="noopener">https://hashkiller.co.uk</a>,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0c5ff0f900941747d69b7a4de4c8da40 MD5 : g1Mm</span><br><span class="line">a8ce348b696e32e6d619c34f906e5a83 MD5 : 3Th3</span><br><span class="line">c05e2754376ae75499b5170314a6e54c MD5 : r3D1</span><br></pre></td></tr></table></figure></p>
<p>Final <code>user_input</code> string, <code>giMm3Th3r3D1</code>. Welp, too bad the service is down after CTF ends. But this is the answer tho, solved while CTF still running. Anyway, to get the flag, you just need to write the final <code>user_input</code> to <code>/proc/bluepill</code> for example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -ne &apos;giMm3Th3r3D1&apos; &gt; /proc/bluepill</span><br></pre></td></tr></table></figure>
<p>Then, you will get an escalated permission to read the flag file.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&text=Security Fest CTF 2018 - bluepill"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&is_video=false&description=Security Fest CTF 2018 - bluepill"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Security Fest CTF 2018 - bluepill&body=Check out this article: https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&title=Security Fest CTF 2018 - bluepill"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://zeroload.github.io/2018/06/02/Security-Fest-CTF-2018-bluepill/&name=Security Fest CTF 2018 - bluepill&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 zeroload
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'zeroload-github-io';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


